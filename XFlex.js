const ua=navigator.userAgent.toLowerCase(),isIOS=ua.includes("iphone os")||ua.includes("mac os")&&navigator.maxTouchPoints>0,isAndroid=ua.includes("android"),isMobile=ua.includes("android")||isIOS,isSafari=ua.includes("safari/"),isFirefox=ua.includes("firefox/"),isOldFirefox=ua.includes("firefox/")&&ua.split("firefox/")[1].split(".")[0]<103,switchers={theme:["auto","light","dark"],vCodec:["h264","av1","vp9"],vQuality:["720","max","2160","1440","1080","480","360","240","144"],aFormat:["mp3","best","ogg","wav","opus"],audioMode:["false","true"],filenamePattern:["classic","pretty","basic","nerdy"]},checkboxes=["alwaysVisibleButton","downloadPopup","fullTikTokAudio","muteAudio","reduceTransparency","disableAnimations","disableMetadata","twitterGif","plausible_ignore","ytDub","tiktokH265"],bottomPopups=["error","download"];let store={};const validLink=e=>{try{return/^https:/i.test(new URL(e).protocol)}catch{return!1}},fixApiUrl=e=>e.endsWith("/")?e.slice(0,-1):e;let apiURL=fixApiUrl(defaultApiUrl);const changeApi=e=>(apiURL=fixApiUrl(e),!0),eid=e=>document.getElementById(e),sGet=e=>localStorage.getItem(e),sSet=(e,a)=>{localStorage.setItem(e,a)},lazyGet=e=>{const a=sGet(e);if(e in switchers){if(switchers[e][0]!==a)return a}else if(checkboxes.includes(e)&&a==="true")return!0},changeDownloadButton=(e,a)=>{switch(e){case"hidden":eid("download-button").disabled=!0,sGet("alwaysVisibleButton")==="true"?(eid("download-button").value=">>",eid("download-button").style.padding="0 1rem"):(eid("download-button").value="",eid("download-button").style.padding="0");break;case"disabled":eid("download-button").disabled=!0,eid("download-button").value=a,eid("download-button").style.padding="0 1rem";break;default:eid("download-button").disabled=!1,eid("download-button").value=">>",eid("download-button").style.padding="0 1rem";break}},button=()=>{let e=validLink(eid("url-input-area").value);eid("url-clear").style.display="none",eid("url-input-area").value.length>0&&(eid("url-clear").style.display="block"),e?changeDownloadButton():changeDownloadButton("hidden")},clearInput=()=>{eid("url-input-area").value="",button()},copy=(e,a)=>{let t=document.getElementById(e);t.classList.add("text-backdrop"),setTimeout(()=>{t.classList.remove("text-backdrop")},600),a?navigator.clipboard.writeText(a):navigator.clipboard.writeText(t.textContent)},share=e=>navigator?.share({url:e}).catch(()=>{}),preferredColorScheme=()=>{let e="auto",a=sGet("theme"),t=!1;return a&&(e=a),window.matchMedia&&(t=window.matchMedia("(prefers-color-scheme: light)").matches),e==="auto"&&(e=t?"light":"dark"),e},changeStatusBarColor=()=>{const e=preferredColorScheme(),a={dark:"#000000",light:"#ffffff","dark-popup":"#151515","light-popup":"#ebebeb"};let t=store.isPopupOpen?"dark-popup":"dark";e==="light"&&(t=store.isPopupOpen?"light-popup":"light"),document.querySelector('meta[name="theme-color"]').setAttribute("content",a[t])},detectColorScheme=()=>{document.documentElement.setAttribute("data-theme",preferredColorScheme()),changeStatusBarColor()};window.matchMedia&&window.matchMedia("(prefers-color-scheme: light)").addEventListener("change",()=>{changeStatusBarColor(),detectColorScheme()});const updateFilenamePreview=()=>{let e="",a="",t={max:"3840x2160",2160:"3840x2160",1440:"2560x1440",1080:"1920x1080",720:"1280x720",480:"854x480",360:"640x360"};switch(sGet("filenamePattern")){case"classic":e=`youtube_dQw4w9WgXcQ_${t[sGet("vQuality")]}_${sGet("vCodec")}${sGet("muteAudio")==="true"?"_mute":""}.${sGet("vCodec")==="vp9"?"webm":"mp4"}`,a=`youtube_dQw4w9WgXcQ_audio.${sGet("aFormat")!=="best"?sGet("aFormat"):"opus"}`;break;case"basic":e=`${loc.FilenamePreviewVideoTitle} (${sGet("vQuality")==="max"?"2160p":`${sGet("vQuality")}p`}, ${sGet("vCodec")}${sGet("muteAudio")==="true"?", mute":""}).${sGet("vCodec")==="vp9"?"webm":"mp4"}`,a=`${loc.FilenamePreviewAudioTitle} - ${loc.FilenamePreviewAudioAuthor}.${sGet("aFormat")!=="best"?sGet("aFormat"):"opus"}`;break;case"pretty":e=`${loc.FilenamePreviewVideoTitle} (${sGet("vQuality")==="max"?"2160p":`${sGet("vQuality")}p`}, ${sGet("vCodec")}, ${sGet("muteAudio")==="true"?"mute, ":""}youtube).${sGet("vCodec")==="vp9"?"webm":"mp4"}`,a=`${loc.FilenamePreviewAudioTitle} - ${loc.FilenamePreviewAudioAuthor} (soundcloud).${sGet("aFormat")!=="best"?sGet("aFormat"):"opus"}`;break;case"nerdy":e=`${loc.FilenamePreviewVideoTitle} (${sGet("vQuality")==="max"?"2160p":`${sGet("vQuality")}p`}, ${sGet("vCodec")}, ${sGet("muteAudio")==="true"?"mute, ":""}youtube, dQw4w9WgXcQ).${sGet("vCodec")==="vp9"?"webm":"mp4"}`,a=`${loc.FilenamePreviewAudioTitle} - ${loc.FilenamePreviewAudioAuthor} (soundcloud, 1242868615).${sGet("aFormat")!=="best"?sGet("aFormat"):"opus"}`;break}eid("video-filename-text").innerHTML=e,eid("audio-filename-text").innerHTML=a},changeTab=(e,a,t)=>{a==="tab-settings-other"&&updateFilenamePreview();let o=document.getElementsByClassName(`tab-content-${t}`),i=document.getElementsByClassName(`tab-${t}`);for(let r=0;r<o.length;r++)o[r].dataset.enabled="false";for(let r=0;r<i.length;r++)i[r].dataset.enabled="false";e.currentTarget.dataset.enabled="true",eid(a).dataset.enabled="true",eid(a).parentElement.scrollTop=0},expandCollapsible=e=>{let a=e.currentTarget.parentNode.classList,t="expanded";a.contains(t)?a.remove(t):a.add(t)},hideAllPopups=()=>{let e=document.getElementsByClassName("popup");for(let a=0;a<e.length;a++)e[a].classList.remove("visible");eid("popup-backdrop").classList.remove("visible"),store.isPopupOpen=!1,eid("picker-holder").innerHTML="",eid("picker-download").href="/",eid("picker-download").classList.remove("visible")},popup=(e,a,t)=>{if(a===1)switch(hideAllPopups(),store.isPopupOpen=!0,bottomPopups.includes(e)||changeStatusBarColor(),e){case"about":let o="about";t&&(o=t),eid(`tab-button-${e}-${o}`).click();break;case"settings":eid(`tab-button-${e}-video`).click();break;case"error":eid("desc-error").innerHTML=t;break;case"download":eid("pd-download").href=t,eid("pd-copy").setAttribute("onClick",`copy('pd-copy', '${t}')`),eid("pd-share").setAttribute("onClick",`share('${t}')`),navigator.canShare&&(eid("pd-share").style.display="flex");break;case"picker":switch(eid("picker-title").innerHTML=loc.MediaPickerTitle,eid("picker-subtitle").innerHTML=isMobile?loc.MediaPickerExplanationPhone:loc.MediaPickerExplanationPC,t.type){case"images":eid("picker-holder").classList.remove("various"),eid("picker-download").href=t.audio,eid("picker-download").classList.add("visible");for(let i in t.arr)eid("picker-holder").innerHTML+=`<a class="picker-image-container" ${isIOS?`onClick="share('${t.arr[i].url}')"`:`href="${t.arr[i].url}" target="_blank"`}><img class="picker-image" src="${t.arr[i].url}" onerror="this.parentNode.style.display='none'"></a>`;break;default:eid("picker-holder").classList.add("various");for(let i in t.arr)eid("picker-holder").innerHTML+=`<a class="picker-image-container" ${isIOS?`onClick="share('${t.arr[i].url}')"`:`href="${t.arr[i].url}" target="_blank"`}><div class="picker-element-name">${t.arr[i].type}</div>`+(t.arr[i].type==="photo"?"":'<div class="imageBlock"></div>')+`<img class="picker-image" src="${t.arr[i].thumb}" onerror="this.style.display='none'"></a>`;eid("picker-download").classList.remove("visible");break}break;default:break}else store.isPopupOpen=!1,changeStatusBarColor(),e==="picker"&&(eid("picker-download").href="/",eid("picker-download").classList.remove("visible"),eid("picker-holder").innerHTML="");bottomPopups.includes(e)&&eid(`popup-${e}-container`).classList.toggle("visible"),eid("popup-backdrop").classList.toggle("visible"),eid(`popup-${e}`).classList.toggle("visible"),eid(`popup-${e}`).focus()},changeSwitcher=(e,a)=>{if(a){switchers[e].includes(a)||(a=switchers[e][0]),sSet(e,a);for(let t in switchers[e])switchers[e][t]===a?eid(`${e}-${a}`).dataset.enabled="true":eid(`${e}-${switchers[e][t]}`).dataset.enabled="false";e==="theme"&&detectColorScheme(),e==="filenamePattern"&&updateFilenamePreview()}else{let t=switchers[e][0];sSet(e,t);for(let o in switchers[e])switchers[e][o]===t?eid(`${e}-${t}`).dataset.enabled="true":eid(`${e}-${switchers[e][o]}`).dataset.enabled="false"}},checkbox=e=>{switch(sSet(e,!!eid(e).checked),e){case"alwaysVisibleButton":button();break;case"reduceTransparency":eid("XFlex-body").classList.toggle("no-transparency");break;case"disableAnimations":eid("XFlex-body").classList.toggle("no-animation");break}},changeButton=(e,a)=>{switch(e){case"error":eid("url-input-area").disabled=!1,eid("url-clear").style.display="block",changeDownloadButton("disabled","!!"),popup("error",1,a),setTimeout(()=>{changeButton("default")},2500);break;case"default":changeDownloadButton(),eid("url-clear").style.display="block",eid("url-input-area").disabled=!1;break;case"error-default":popup("error",1,a),changeDownloadButton(),eid("url-clear").style.display="block",eid("url-input-area").disabled=!1;break}},internetError=()=>{eid("url-input-area").disabled=!1,changeDownloadButton("disabled","!!"),setTimeout(()=>{changeButton("default")},2500),popup("error",1,loc.ErrorNoInternet)},resetSettings=()=>{localStorage.clear(),window.location.reload()},download=async e=>{changeDownloadButton("disabled","..."),eid("url-clear").style.display="none",eid("url-input-area").disabled=!0;let a={url:e,vCodec:lazyGet("vCodec"),vQuality:lazyGet("vQuality"),aFormat:lazyGet("aFormat"),filenamePattern:lazyGet("filenamePattern"),isAudioOnly:lazyGet("audioMode"),isTTFullAudio:lazyGet("fullTikTokAudio"),isAudioMuted:lazyGet("muteAudio"),disableMetadata:lazyGet("disableMetadata"),dubLang:lazyGet("ytDub"),twitterGif:lazyGet("twitterGif"),tiktokH265:lazyGet("tiktokH265")},t=await fetch(`${apiURL}/api/json`,{method:"POST",body:JSON.stringify(a),headers:{Accept:"application/json","Content-Type":"application/json"}}).then(o=>o.json()).catch(()=>{});if(!t){internetError();return}if((t.status==="error"||t.status==="rate-limit")&&t&&t.text){changeButton("error",t.text);return}switch(t.text&&(!t.url||!t.picker)&&(t.status==="success"?changeButton("error-default",t.text):changeButton("error",loc.ErrorNoUrlReturned)),t.status){case"redirect":changeDownloadButton("disabled",">>>"),setTimeout(()=>{changeButton("default")},1500),sGet("downloadPopup")==="true"?popup("download",1,t.url):window.open(t.url,"_blank");break;case"stream":changeDownloadButton("disabled","?..");let o=await fetch(`${t.url}&p=1`).then(i=>i.json()).catch(()=>{});if(!o)return internetError();if(o.status!=="continue"){changeButton("error",o.text);return}changeDownloadButton("disabled",">>>"),sGet("downloadPopup")==="true"?popup("download",1,t.url):isMobile||isSafari?window.location.href=t.url:window.open(t.url,"_blank"),setTimeout(()=>{changeButton("default")},2500);break;case"picker":t.audio&&t.picker?(changeDownloadButton("disabled",">>>"),popup("picker",1,{audio:t.audio,arr:t.picker,type:t.pickerType}),setTimeout(()=>{changeButton("default")},2500)):t.picker?(changeDownloadButton("disabled",">>>"),popup("picker",1,{arr:t.picker,type:t.pickerType}),setTimeout(()=>{changeButton("default")},2500)):changeButton("error",loc.ErrorNoUrlReturned);break;case"success":changeButton("error-default",t.text);break;default:changeButton("error",loc.ErrorUnknownStatus);break}},pasteClipboard=async()=>{try{let a=(await navigator.clipboard.readText()).match(/https:\/\/[^\s]+/g);a&&(eid("url-input-area").value=a,download(eid("url-input-area").value))}catch(e){let a=loc.FeatureErrorGeneric,t=!0,o=String(e).toLowerCase();o.includes("denied")&&(a=loc.ClipboardErrorNoPermission),(o.includes("dismissed")||isIOS)&&(t=!1),o.includes("function")&&isFirefox&&(a=loc.ClipboardErrorFirefox),t&&popup("error",1,a)}},loadCelebrationsEmoji=async()=>{let e=eid("about-footer").innerHTML;try{let a=await fetch("/onDemand?blockId=1").then(t=>t.json()).catch(()=>{});a&&a.status==="success"&&a.text&&(eid("about-footer").innerHTML=eid("about-footer").innerHTML.replace(`${e.split("> ")[0]}>`,a.text))}catch{eid("about-footer").innerHTML=e}},loadOnDemand=async(e,a)=>{store.historyButton=eid(e).innerHTML,eid(e).innerHTML='<div class="loader">...</div>';try{if(!store.historyContent){let t=await fetch(`/onDemand?blockId=${a}`).then(o=>o.json()).catch(()=>{});if(!t)throw new Error;t.status==="success"&&(store.historyContent=t.text)}eid(e).innerHTML=`<button class="switch bottom-margin" onclick="restoreUpdateHistory()">
                ${loc.ChangelogPressToHide}
            </button>
            ${store.historyContent}`}catch{eid(e).innerHTML=store.historyButton,internetError()}},restoreUpdateHistory=()=>{eid("changelog-history").innerHTML=store.historyButton},loadSettings=()=>{sGet("alwaysVisibleButton")==="true"&&(eid("alwaysVisibleButton").checked=!0,eid("download-button").value=">>",eid("download-button").style.padding="0 1rem"),sGet("downloadPopup")==="true"&&!isIOS&&(eid("downloadPopup").checked=!0),(sGet("reduceTransparency")==="true"||isOldFirefox)&&eid("XFlex-body").classList.add("no-transparency"),sGet("disableAnimations")==="true"&&eid("XFlex-body").classList.add("no-animation"),isMobile||eid("XFlex-body").classList.add("desktop"),isAndroid&&eid("XFlex-body").classList.add("android"),isIOS&&(eid("download-switcher").querySelector(".explanation").innerHTML=loc.DownloadPopupDescriptionIOS);for(let e=0;e<checkboxes.length;e++)try{sGet(checkboxes[e])==="true"&&(eid(checkboxes[e]).checked=!0)}catch{console.error(`checkbox ${checkboxes[e]} failed to initialize`)}for(let e in switchers)changeSwitcher(e,sGet(e));updateFilenamePreview()};window.onload=()=>{loadCelebrationsEmoji(),loadSettings(),detectColorScheme(),changeDownloadButton("hidden"),eid("url-input-area").value="",isIOS&&(sSet("downloadPopup","true"),eid("downloadPopup-chkbx").style.display="none"),eid("home").style.visibility="visible",eid("home").classList.toggle("visible");const e=new URLSearchParams(window.location.search);e.has("u")&&validLink(e.get("u"))&&(eid("url-input-area").value=e.get("u"),button()),window.history.replaceState(null,"",window.location.pathname),isIOS&&document.addEventListener("touchstart",()=>{},!0)},eid("url-input-area").addEventListener("keydown",()=>{button()}),eid("url-input-area").addEventListener("keyup",e=>{e.key==="Enter"&&eid("download-button").click()}),document.addEventListener("keydown",e=>{e.key==="Tab"&&(eid("download-button").value=">>",eid("download-button").style.padding="0 1rem")}),document.onkeydown=e=>{if(store.isPopupOpen)e.key==="Escape"&&hideAllPopups();else{if((e.metaKey||e.ctrlKey||e.key==="/")&&eid("url-input-area").focus(),(e.key==="Escape"||e.key==="Clear")&&clearInput(),e.target===eid("url-input-area"))return;e.key==="D"&&pasteClipboard(),e.key==="K"&&changeSwitcher("audioMode","false"),e.key==="L"&&changeSwitcher("audioMode","true"),e.key==="B"&&popup("about",1,"about"),e.key==="N"&&popup("about",1,"changelog"),e.key==="M"&&popup("settings",1)}};
